# MasterPlan – Business Rules (v1.1, MVP)

## 1. 목적과 배경
MasterPlan은 주문생산 공작기계 특성상 빈번하게 발생하는 고객 요구 변경/설계 변경/납기 조정/내외부 지연을
**숨기지 않고 기록**하고, 현업이 실제로 사용할 수 있도록 **단순하고 명료한 규칙**으로 운영되는 마스터스케줄 시스템이다.

---

## 2. 기본 원칙
1) 변경은 자연스러운 일이며, 기록이 핵심이다.  
2) 권한과 책임은 일치해야 한다.  
3) 시스템은 불편하지 않아야 사용된다(MVP는 단순/유지보수 우선).  
4) 명칭은 바뀔 수 있으나, 식별자는 변하지 않아야 한다(조인으로 최신 명칭 표시).

---

## 3. 프로젝트 및 납기(최종 납기) 관리

### 3.1 프로젝트 단위
- 모든 일정 관리는 프로젝트 단위로 수행한다.
- 프로젝트는 ERP에서 수주된 프로젝트를 기준으로 한다(ERP 캐시 테이블 사용).

### 3.2 프로젝트 최종 납기(프로젝트당 1개)
- 프로젝트당 최종 납기 1개만 관리한다.
- 최종 납기는 다음 두 가지로 구분한다.

| 구분 | 설명 |
|---|---|
| Baseline Due Date | 최초 계약/최초 합의된 납기 |
| Current Due Date | 변경 후 현재 합의된 납기 |

- Current Due Date는 Baseline Due Date와 **같은 날짜로 설정할 수 없다**.
- Current Due Date는 **앞당겨질 수도 있고, 연장될 수도 있다**.

### 3.3 납기 변경 권한
- **프로젝트 최종 납기 변경 권한은 영업 부서**에 있다.

---

## 4. 분류(대/중/소) 및 Row(작업) 생성 규칙

### 4.1 작업(Row)의 정의
- MasterPlan에서 Row(작업)는 **소분류(Category S)**로만 생성된다.
- 대분류/중분류는 작업이 될 수 없으며, **그룹(헤더)로만 사용**한다.

### 4.2 Row 추가(등록) 규칙
- 사용자는 UI에서 **대/중/소를 따라 내려가 소분류를 선택**해야만 Row를 추가할 수 있다.
- 프로젝트 내 동일 소분류(Row)는 **1회만 선택 가능**하다(중복 불가).

### 4.3 “중분류 저장 안 함”의 의미
- 프로젝트 작업 데이터는 `schedule_item`에 **소분류(cat_s_id)만 저장**한다.
- 화면에서의 대/중/소 계층 표시는 `category_*` 조인을 통해 **조회 시 계산**한다.
- 따라서 분류 명칭이 변경되거나, 소분류가 매핑된 중분류 구성이 바뀌어도,
  프로젝트 데이터는 꼬이지 않는다(식별자는 cat_s_id로 유지).

---

## 5. 계획(Plan) 관리 규칙

### 5.1 계획의 종류
각 작업(Row)은 다음 두 가지 계획을 가질 수 있다.

| 구분 | 설명 |
|---|---|
| Baseline Plan | 최초 수립된 기준 계획 |
| Current Plan | 변경 후 현재 적용 계획 |

- Baseline Plan은 Row 생성 시 **즉시 입력**한다.
- Baseline Plan은 원칙적으로 “수정”하지 않는다.

### 5.2 계획 변경 권한(중요: 프로젝트 납기와 분리)
- 프로젝트 최종 납기는 영업이 변경한다.
- 작업(소분류) 계획(Current Plan)은 **해당 작업의 담당 부서(Owner Dept)**가 변경한다.

### 5.3 Baseline 실수 처리(운영 편의 우선)
- Baseline을 실수로 잘못 입력한 경우,
  - 실적이 없다면 Row를 삭제하고 다시 등록하는 방식으로 정정한다.
  - 실적이 있다면 삭제 불가(추후 확장 규칙 포함). 필요한 경우 Current로 조정한다.

---

## 6. 실적(Actual) 관리 규칙

### 6.1 실적 입력 방식(MVP)
- 실적은 작업(Row)당 1회만 관리한다.
- 실적 데이터는 다음만 가진다.
  - 실제 시작일(actual_start_date)
  - 실제 종료일(actual_end_date)
- 일자별 실적/공수/수량은 MVP 범위에서 제외한다.

---

## 7. 상태/표시/알림 규칙

### 7.1 기준 종료일(basis end date)
- 기준 종료일은 다음 우선순위로 판단한다.
  1) Current Plan 종료일(존재할 경우)
  2) Baseline Plan 종료일

### 7.2 화면 표시 원칙(단순/직관)
- “계획변경(Current 존재)” 같은 배지를 모든 Row에 표시하여 복잡하게 만들지 않는다.
- Row에서는 **화살표(Bar) 색/형태**로만 의미를 전달한다.
  - Baseline Plan bar
  - Current Plan bar(있을 때만, 단축/연장 색으로 구분 가능)
  - Actual bar

### 7.3 프로젝트/작업 용어
- 프로젝트 수준: **납기연장 / 납기단축**
- 작업(Row) 수준: **진행지연**

### 7.4 진행지연 알림(대시보드 1줄)
- 팝업/메일은 MVP에서 제외한다.
- 화면 상단(대시보드/작업표시줄) 한 줄로 알림한다.
  - “기준 종료일이 임박했습니다”
  - “기준 종료일이 지났습니다”

---

## 8. 권한 및 CRUD 규칙

### 8.1 기본 원칙
- 사용자는 기본적으로 **본인 부서 데이터만 CRUD 가능**하다.
- 타 부서 데이터는 Read-only이다.

### 8.2 예외 권한
- 전체 관리자(개발자)
- 부서별 관리자(팀장)
- 개별 사용자 권한 부여 가능(예: ADMIN)

---

## 9. 사유(Reason) 및 감사로그(Audit)

### 9.1 사유 입력 정책(불편 최소화)
- 모든 행위에 사유를 강제하면 불편해져 사용성이 떨어진다.
- 따라서 사유는 **중요 변경에만 필수**로 강제한다(강제는 API에서 수행).

사유 필수(예):
- 프로젝트 최종 납기 변경(영업)
- 작업 Current Plan 변경(담당부서)
- 실적 입력/변경(담당부서)

사유 선택/생략 가능(예):
- 실적 없는 Row 삭제(단순 실수 정정)

### 9.2 “기타 + 메모”
- 명확한 사유 선택이 어려운 경우를 위해 `ETC(기타)` 사유를 제공한다.
- `ETC` 선택 시 메모 입력을 권장(필수 여부는 API 정책으로 결정).

### 9.3 감사로그
- 중요한 변경은 감사로그에 남긴다.
- 로그에는 누가/언제/무엇을/어떻게/왜(가능하면) 기록한다.
- MVP에서는 감사로그의 reason_code는 NULL 허용이며,
  사유 필수 정책은 API에서 처리한다.

---

## 10. MVP 범위
포함:
- 프로젝트 선택(ERP 캐시)
- 대/중/소 트리에서 소분류 선택 → Row 생성
- Baseline/Current 계획 관리
- 실적(시작/종료) 1회 관리
- 진행지연/납기연장 표시(조회 계산)
- 감사로그(중요 변경 위주)

제외(향후):
- 연결 작업(체인) 제약(중간 삭제 금지 등)
- 알림 확장(메일/메신저)
- 일자별 실적/공수/수량
- 인증/권한 고도화(RLS 등)

---
